<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Personaje</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary:    #050507;
            --bg-secondary:  #101014;
            --bg-card:       #18181e;
            --border:        #23232C;
            --border-hover:  #30303A;
            --accent:        #EBB34B;
            --accent-dim:    rgba(235,179,75,0.15);
            --accent-glow:   rgba(235,179,75,0.1);
            --text-primary:  #F2F2F5;
            --text-secondary:#9E9EA8;
            --text-muted:    #6B6B76;
            --success:       #10b981;
            --success-dim:   rgba(16,185,129,0.12);
            --error:         #ef4444;
            --nsfw:          #e05a7a;
            --nsfw-dim:      rgba(224,90,122,0.1);
            --nsfw-glow:     rgba(224,90,122,0.06);
            --companion:     #7c6af5;
            --companion-dim: rgba(124,106,245,0.12);
            --radius:        14px;
            --font-sans:     'Inter', system-ui, sans-serif;
            --font-serif:    'Crimson Pro', Georgia, serif;
            --font-mono:     'JetBrains Mono', monospace;
            --shadow-sm:     0 2px 8px rgba(0,0,0,0.4);
            --shadow-lg:     0 12px 32px rgba(0,0,0,0.6);
            --shadow-glow:   0 0 20px rgba(235,179,75,0.35);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 1rem;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            background-image:
                radial-gradient(circle at 50% 0%, rgba(235,179,75,0.03) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(255,255,255,0.02) 0%, transparent 50%);
        }

        .page-wrap { max-width: 780px; margin: 0 auto; padding: 40px 20px 80px; }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .page-header { display: flex; align-items: center; gap: 16px; margin-bottom: 40px; }

        .back-btn {
            display: inline-flex; align-items: center; gap: 8px;
            color: var(--text-secondary); text-decoration: none;
            font-family: var(--font-mono); font-size: 0.8rem;
            border: 1px solid var(--border); padding: 10px 16px;
            border-radius: 10px; background: var(--bg-secondary);
            transition: all 0.2s; white-space: nowrap;
            height: 44px; box-sizing: border-box;
        }
        .back-btn:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-dim); transform: translateX(-2px); }

        .page-title {
            font-size: 1.6rem; font-weight: 600; letter-spacing: -0.03em;
            font-family: var(--font-sans);
            background: linear-gradient(to right, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .page-title span { -webkit-text-fill-color: var(--accent); font-style: normal; }

        /* ‚îÄ‚îÄ Toggle NSFW ‚îÄ‚îÄ */
        .nsfw-toggle-wrap {
            display: flex; align-items: center; gap: 12px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 14px 18px;
            margin-bottom: 16px; cursor: pointer;
            transition: all 0.2s;
            user-select: none; min-height: 56px;
        }
        .nsfw-toggle-wrap:hover { border-color: var(--border-hover); background: #1e1e26; }
        .nsfw-toggle-wrap.activo { border-color: var(--nsfw); background: var(--nsfw-dim); }

        /* ‚îÄ‚îÄ Toggle Modo Memoria ‚îÄ‚îÄ */
        .modo-toggle-wrap {
            display: flex; align-items: center; gap: 12px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 14px 18px;
            margin-bottom: 16px; cursor: pointer;
            transition: all 0.2s;
            user-select: none; min-height: 56px;
        }
        .modo-toggle-wrap:hover { border-color: var(--border-hover); background: #1e1e26; }
        .modo-toggle-wrap.companion { border-color: var(--companion); background: var(--companion-dim); }

        .modo-toggle-switch {
            width: 40px; height: 22px; border-radius: 11px;
            background: var(--border); position: relative;
            transition: background 0.25s; flex-shrink: 0;
        }
        .modo-toggle-switch::after {
            content: ''; position: absolute; top: 3px; left: 3px;
            width: 16px; height: 16px; border-radius: 50%;
            background: var(--text-secondary); transition: transform 0.25s, background 0.25s;
        }
        .modo-toggle-wrap.companion .modo-toggle-switch { background: var(--companion); }
        .modo-toggle-wrap.companion .modo-toggle-switch::after { transform: translateX(18px); background: #fff; }

        .nsfw-toggle-switch {
            width: 40px; height: 22px; border-radius: 11px;
            background: var(--border); position: relative;
            transition: background 0.25s; flex-shrink: 0;
        }
        .nsfw-toggle-switch::after {
            content: ''; position: absolute; top: 3px; left: 3px;
            width: 16px; height: 16px; border-radius: 50%;
            background: var(--text-muted); transition: all 0.25s;
        }
        .nsfw-toggle-wrap.activo .nsfw-toggle-switch { background: var(--nsfw); }
        .nsfw-toggle-wrap.activo .nsfw-toggle-switch::after {
            background: white; left: 21px;
        }
        .nsfw-toggle-texto { flex: 1; }
        .nsfw-toggle-titulo {
            font-family: var(--font-mono);
            font-size: 0.78rem; letter-spacing: 0.05em;
            color: var(--text-primary); margin-bottom: 2px; font-weight: 500;
        }
        .nsfw-toggle-wrap.activo .nsfw-toggle-titulo { color: var(--nsfw); }
        .nsfw-toggle-desc { font-size: 0.82rem; color: var(--text-secondary); }

        /* ‚îÄ‚îÄ Panel NSFW ‚îÄ‚îÄ */
        .nsfw-panel {
            display: none;
            background: var(--bg-card);
            border: 1px solid rgba(224,90,122,0.35);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 16px;
            animation: slideIn 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .nsfw-panel.visible { display: block; }

        .nsfw-panel-titulo {
            font-family: var(--font-mono);
            font-size: 0.72rem; letter-spacing: 0.1em;
            text-transform: uppercase; color: var(--nsfw);
            margin-bottom: 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .nsfw-panel-titulo::before { content: '‚ú¶'; font-size: 0.58rem; }

        .nsfw-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .nsfw-field label {
            color: var(--nsfw);
            font-size: 0.68rem;
            opacity: 0.85;
        }

        .nsfw-field input,
        .nsfw-field textarea {
            border-color: rgba(224,90,122,0.3);
        }
        .nsfw-field input:focus,
        .nsfw-field textarea:focus {
            border-color: var(--nsfw);
            box-shadow: 0 0 0 3px var(--nsfw-glow);
        }

        /* ‚îÄ‚îÄ Selector de modo ‚îÄ‚îÄ */
        .modo-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 24px; }

        .modo-btn {
            padding: 18px 14px; border-radius: var(--radius);
            border: 1px solid var(--border); background: var(--bg-card);
            cursor: pointer; text-align: left;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            color: var(--text-primary); font-family: var(--font-sans);
        }
        .modo-btn:hover { border-color: var(--border-hover); background: #1e1e26; }
        .modo-btn.selected { border-color: var(--accent); background: var(--accent-dim); box-shadow: 0 0 20px rgba(235,179,75,0.08); }
        .modo-btn-icon { font-size: 1.4rem; margin-bottom: 8px; }
        .modo-btn-titulo { font-size: 0.9rem; font-weight: 600; margin-bottom: 4px; font-family: var(--font-sans); }
        .modo-btn.selected .modo-btn-titulo { color: var(--accent); }
        .modo-btn-desc { font-size: 0.76rem; color: var(--text-secondary); line-height: 1.45; font-weight: 300; }
        .modo-badge {
            display: inline-block; font-family: var(--font-mono);
            font-size: 0.58rem; letter-spacing: 0.07em; text-transform: uppercase;
            background: var(--accent); color: #0a0a0d;
            padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle;
        }

        /* ‚îÄ‚îÄ Progress ‚îÄ‚îÄ */
        .progress-wrap { margin-bottom: 32px; padding: 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); }
        .progress-steps { display: flex; position: relative; }
        .progress-steps::before {
            content: ''; position: absolute; top: 15px; left: 16px; right: 16px;
            height: 1px; background: var(--border); z-index: 0;
        }
        .step-dot { display: flex; flex-direction: column; align-items: center; gap: 7px; flex: 1; position: relative; z-index: 1; }
        .step-dot-circle {
            width: 32px; height: 32px; border-radius: 50%;
            border: 1px solid var(--border); background: var(--bg-secondary);
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-mono); font-size: 0.72rem;
            color: var(--text-muted); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .step-dot.active .step-dot-circle { border-color: var(--accent); background: var(--accent-dim); color: var(--accent); box-shadow: var(--shadow-glow); }
        .step-dot.done .step-dot-circle { border-color: var(--success); background: var(--success-dim); color: var(--success); }
        .step-dot-label { font-family: var(--font-mono); font-size: 0.58rem; letter-spacing: 0.07em; text-transform: uppercase; color: var(--text-muted); text-align: center; transition: color 0.3s; }
        .step-dot.active .step-dot-label { color: var(--accent); }
        .step-dot.done .step-dot-label { color: var(--success); }

        /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
        .step-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 28px; margin-bottom: 20px; display: none; animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .step-card.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

        .step-card-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 6px; font-family: var(--font-sans); letter-spacing: -0.02em; }
        .step-card-hint { font-size: 0.87rem; color: var(--text-secondary); margin-bottom: 18px; line-height: 1.6; font-weight: 300; }
        .step-card-hint strong { color: var(--accent); font-style: normal; font-weight: 600; }

        .callout {
            background: var(--bg-secondary); border-left: 3px solid var(--accent);
            border-radius: 0 10px 10px 0; padding: 14px 18px; margin-bottom: 18px;
            font-size: 0.84rem; color: var(--text-secondary); line-height: 1.65;
        }
        .callout strong { color: var(--text-primary); font-weight: 600; }
        .callout code { font-family: var(--font-mono); font-size: 0.78rem; background: var(--accent-dim); color: var(--accent); padding: 1px 6px; border-radius: 4px; }

        /* ‚îÄ‚îÄ Secciones de preguntas ‚îÄ‚îÄ */
        .seccion-titulo {
            font-family: var(--font-mono);
            font-size: 0.7rem; letter-spacing: 0.1em;
            text-transform: uppercase; color: var(--accent);
            margin: 28px 0 16px;
            display: flex; align-items: center; gap: 10px;
        }
        .seccion-titulo::after { content: ''; flex: 1; height: 1px; background: linear-gradient(to right, var(--border), transparent); }
        .seccion-titulo:first-child { margin-top: 0; }

        .preguntas-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .pregunta-full { grid-column: 1 / -1; }

        /* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
        .form-group { margin-bottom: 16px; }

        label {
            display: block; font-family: var(--font-mono);
            font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase;
            color: var(--text-secondary); margin-bottom: 7px;
        }

        input[type="text"], textarea {
            width: 100%; background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px 16px; color: var(--text-primary);
            font-family: var(--font-sans); font-size: 0.95rem;
            resize: vertical; outline: none; transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box; -webkit-appearance: none;
        }
        input[type="text"]:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(235,179,75,0.12); }
        textarea { min-height: 90px; }
        textarea.tall { min-height: 145px; }
        textarea.xtall { min-height: 190px; }

        .char-count { font-family: var(--font-mono); font-size: 0.62rem; color: var(--text-muted); text-align: right; margin-top: 4px; }

        /* ‚îÄ‚îÄ Resultado IA ‚îÄ‚îÄ */
        .ia-result-wrap { display: none; margin-top: 18px; }
        .ia-result-wrap.visible { display: block; animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .ia-result-label { font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent); margin-bottom: 9px; display: flex; align-items: center; gap: 8px; }
        .ia-result-label::before { content: '‚ú¶'; font-size: 0.57rem; }
        .ia-result-box { background: var(--bg-secondary); border: 1px solid rgba(235,179,75,0.3); border-left: 3px solid var(--accent); border-radius: 0 10px 10px 0; padding: 16px 18px; font-size: 0.92rem; line-height: 1.8; color: var(--text-primary); white-space: pre-wrap; font-family: var(--font-serif); }

        /* ‚îÄ‚îÄ Tags ‚îÄ‚îÄ */
        .tags-preview { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag-chip { background: var(--accent-dim); border: 1px solid rgba(235,179,75,0.4); color: var(--accent); border-radius: 20px; padding: 5px 14px; font-family: var(--font-mono); font-size: 0.7rem; cursor: pointer; transition: all 0.2s; }
        .tag-chip:hover { background: rgba(235,179,75,0.25); border-color: var(--accent); }
        .tag-chip.desactivado { opacity: 0.3; text-decoration: line-through; }
        .tag-chip::after { content: ' √ó'; opacity: 0.6; }

        /* ‚îÄ‚îÄ Botones ‚îÄ‚îÄ */
        .btn-row { display: flex; gap: 10px; margin-top: 22px; align-items: center; flex-wrap: wrap; }

        .btn { padding: 11px 20px; border-radius: 9px; border: none; cursor: pointer; font-family: var(--font-sans); font-size: 0.87rem; font-weight: 500; letter-spacing: 0; transition: all 0.2s; display: flex; align-items: center; gap: 8px; white-space: nowrap; height: 44px; box-sizing: border-box; }
        .btn:disabled { cursor: not-allowed; opacity: 0.45; }

        .btn-primary { background: var(--accent); color: var(--bg-primary); font-weight: 600; box-shadow: 0 4px 12px rgba(235,179,75,0.2); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.08); box-shadow: 0 6px 20px rgba(235,179,75,0.3); }

        .btn-secondary { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-secondary:hover:not(:disabled) { color: var(--text-primary); border-color: var(--border-hover); background: #1e1e26; }

        .btn-ghost { background: transparent; color: var(--accent); border: 1px solid rgba(235,179,75,0.4); }
        .btn-ghost:hover:not(:disabled) { background: var(--accent-dim); border-color: var(--accent); }

        .btn-generar {
            background: var(--accent);
            color: var(--bg-primary); font-weight: 700; font-size: 0.9rem;
            padding: 14px 26px; width: 100%; justify-content: center;
            margin-top: 10px; box-shadow: 0 4px 20px rgba(235,179,75,0.2);
            height: 52px; border-radius: 10px;
        }
        .btn-generar:hover:not(:disabled) { box-shadow: var(--shadow-glow); transform: translateY(-1px); filter: brightness(1.05); }

        .spinner { width: 15px; height: 15px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.6s linear infinite; display: none; }
        .loading .spinner { display: block; }
        .loading .btn-label { opacity: 0.55; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ Resumen ‚îÄ‚îÄ */
        .resumen-grid { display: grid; gap: 12px; }
        .resumen-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; cursor: pointer; transition: all 0.2s; }
        .resumen-item:hover { border-color: var(--border-hover); background: #1e1e26; }
        .resumen-item-titulo { font-family: var(--font-mono); font-size: 0.63rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent); margin-bottom: 7px; display: flex; align-items: center; gap: 8px; }
        .resumen-item-titulo::after { content: 'Editar ‚Üí'; font-size: 0.58rem; color: var(--text-muted); margin-left: auto; }
        .resumen-item-texto { font-size: 0.87rem; line-height: 1.6; color: var(--text-primary); font-family: var(--font-sans); }
        .resumen-ok { border-left: 3px solid var(--success); }
        .resumen-vacio { border-left: 3px solid var(--text-muted); }

        /* ‚îÄ‚îÄ Notif ‚îÄ‚îÄ */
        .notif { position: fixed; bottom: 20px; left: 50%; width: calc(100% - 32px); max-width: 400px; transform: translateX(-50%) translateY(20px); background: var(--bg-card); border: 1px solid var(--border-hover); border-radius: 12px; padding: 14px 20px; font-family: var(--font-sans); font-size: 0.87rem; font-weight: 500; opacity: 0; transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 999; box-shadow: var(--shadow-lg); box-sizing: border-box; }
        .notif.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .notif.success { border-bottom: 3px solid var(--success); color: var(--success); }
        .notif.error   { border-bottom: 3px solid var(--error);   color: var(--error); }
        .notif.info    { border-bottom: 3px solid var(--accent);  color: var(--accent); }

        /* ‚îÄ‚îÄ √âxito ‚îÄ‚îÄ */
        .success-screen { display: none; text-align: center; padding: 60px 32px; }
        .success-screen.show { display: block; animation: slideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .success-icon { font-size: 3.5rem; margin-bottom: 20px; }
        .success-title { font-size: 1.8rem; font-weight: 600; margin-bottom: 10px; font-family: var(--font-sans); letter-spacing: -0.02em; }
        .success-subtitle { color: var(--text-secondary); margin-bottom: 32px; font-size: 0.9rem; font-weight: 300; }
        .success-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }

        /* ‚îÄ‚îÄ Overlay de carga ‚îÄ‚îÄ */
        .overlay-carga { display: none; position: fixed; inset: 0; background: rgba(5,5,7,0.9); backdrop-filter: blur(8px); z-index: 100; align-items: center; justify-content: center; flex-direction: column; gap: 20px; }
        .overlay-carga.show { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .overlay-spinner { width: 48px; height: 48px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        .overlay-msg { font-family: var(--font-mono); font-size: 0.82rem; color: var(--accent); letter-spacing: 0.05em; }

        /* ‚îÄ‚îÄ Color picker ‚îÄ‚îÄ */
        .color-row { display: flex; align-items: center; gap: 12px; margin-top: 12px; }
        .color-row label { margin: 0; white-space: nowrap; }
        .color-preview { flex: 1; height: 26px; border-radius: 6px; border: 1px solid var(--border); background: #1a1a2e; display: flex; align-items: center; padding: 0 10px; }
        .color-preview span { font-size: 0.62rem; color: rgba(255,255,255,0.28); font-family: 'JetBrains Mono', monospace; }

        /* ‚îÄ‚îÄ Texto de ayuda bajo cada campo ‚îÄ‚îÄ */
        .ayuda {
            font-size: 0.79rem;
            color: var(--text-muted);
            margin-top: 6px;
            line-height: 1.55;
            font-weight: 300;
        }
        .ayuda strong { color: var(--text-secondary); font-weight: 500; }

        @media (max-width: 580px) {
            .modo-selector { grid-template-columns: 1fr; }
            .preguntas-grid { grid-template-columns: 1fr; }
            .nsfw-grid { grid-template-columns: 1fr; }
            .page-header { flex-wrap: wrap; }
        }
    </style>
</head>
<body>

<!-- Overlay de carga -->
<div class="overlay-carga" id="overlay-carga">
    <div class="overlay-spinner"></div>
    <div class="overlay-msg" id="overlay-msg">Generando personaje...</div>
</div>

<div class="page-wrap">

    <!-- Header -->
    <div class="page-header">
        <a href="/" class="back-btn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
            Volver al chat
        </a>
        <h1 class="page-title">Crear <span>personaje</span></h1>
    </div>

    <!-- ‚ïê‚ïê‚ïê PASO 0: Nombre + modo + NSFW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-card active" id="step-0">
        <h2 class="step-card-title">¬øC√≥mo se llama tu personaje?</h2>

        <div class="form-group" style="margin-bottom:24px">
            <label>Nombre del personaje</label>
            <input type="text" id="input-nombre" placeholder="Ej: Zoro, Elara, Viktor..." maxlength="60" autocomplete="off">
        </div>

        <!-- Toggle Modo Memoria -->
    <div class="modo-toggle-wrap" id="modo-toggle" onclick="toggleModoMemoria()">
        <div class="modo-toggle-switch"></div>
        <div>
            <div style="font-weight:600;font-size:0.95rem" id="modo-toggle-label">üé≠ Modo: Roleplay</div>
            <div style="font-size:0.78rem;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;margin-top:2px" id="modo-toggle-desc">
                La IA solo recuerda datos reales del usuario, no acciones de ficci√≥n
            </div>
        </div>
    </div>

    <!-- Toggle NSFW -->
        <div class="nsfw-toggle-wrap" id="nsfw-toggle" onclick="toggleNSFW()">
            <div class="nsfw-toggle-switch" id="nsfw-switch"></div>
            <div class="nsfw-toggle-texto">
                <div class="nsfw-toggle-titulo">Contenido adulto (NSFW)</div>
                <div class="nsfw-toggle-desc">Activa preguntas y generaci√≥n de contenido √≠ntimo/sexual. Solo para mayores de 18 a√±os.</div>
            </div>        </div>

        <!-- Panel NSFW -->
        <div class="nsfw-panel" id="nsfw-panel">
            <div class="nsfw-panel-titulo">Informaci√≥n √≠ntima del personaje</div>
            <div class="nsfw-grid">
                <div class="form-group nsfw-field">
                    <label>Din√°mica √≠ntima</label>
                    <input type="text" id="nsfw-dinamica" placeholder="Ej: dominante pero atento, sumiso, equilibrado...">
                    <div class="ayuda" style="color:rgba(224,90,122,0.6)">C√≥mo se comporta en general en la intimidad. ¬øLleva la iniciativa o sigue? ¬øEs intenso, tierno, controlado?</div>
                </div>
                <div class="form-group nsfw-field">
                    <label>Rol (dom/sub/switch)</label>
                    <input type="text" id="nsfw-rol" placeholder="Ej: dominante por naturaleza, switch seg√∫n el mood...">
                    <div class="ayuda" style="color:rgba(224,90,122,0.6)"><strong>Dom</strong> = lleva el control. <strong>Sub</strong> = entrega el control. <strong>Switch</strong> = puede ser los dos seg√∫n la situaci√≥n.</div>
                </div>
                <div class="form-group nsfw-field">
                    <label>Preferencias o kinks</label>
                    <input type="text" id="nsfw-preferencias" placeholder="Ej: slow burn, tensi√≥n antes, palabras al o√≠do...">
                    <div class="ayuda" style="color:rgba(224,90,122,0.6)">Lo que le gusta o lo que lo excita. Puede ser tan expl√≠cito o impl√≠cito como quieras.</div>
                </div>
                <div class="form-group nsfw-field">
                    <label>Tono en escenas √≠ntimas</label>
                    <input type="text" id="nsfw-tono" placeholder="Ej: intenso y callado, vocal, tierno pero apasionado...">
                    <div class="ayuda" style="color:rgba(224,90,122,0.6)">¬øC√≥mo cambia su voz y sus palabras? ¬øSe vuelve m√°s directo, m√°s suave? Esto define el estilo de escritura en esas escenas.</div>
                </div>
                <div class="form-group nsfw-field">
                    <label>L√≠mites / hard limits</label>
                    <input type="text" id="nsfw-limites" placeholder="Ej: sin humillaci√≥n, sin violencia, etc.">
                    <div class="ayuda" style="color:rgba(224,90,122,0.6)">Cosas que el personaje nunca har√≠a o que vos no quer√©s ver. La IA las va a evitar activamente.</div>
                </div>
                <div class="form-group nsfw-field">
                    <label>Escena t√≠pica (opcional)</label>
                    <input type="text" id="nsfw-escena" placeholder="Ej: despu√©s de una pelea, en el camarote del barco...">
                    <div class="ayuda" style="color:rgba(224,90,122,0.6)">Un contexto o situaci√≥n donde quer√©s que se desarrolle la intimidad. Ayuda a que el ejemplo generado sea m√°s espec√≠fico.</div>
                </div>
            </div>
        </div>

        <!-- Selector de modo -->
        <div style="margin-bottom:8px"><label>¬øC√≥mo quer√©s crear el personaje?</label></div>
        <div class="modo-selector">
            <button class="modo-btn selected" id="modo-express-btn" onclick="seleccionarModo('express')">
                <div class="modo-btn-icon">‚ö°</div>
                <div class="modo-btn-titulo">Express <span class="modo-badge">Recomendado</span></div>
                <div class="modo-btn-desc">Escrib√≠s todo lo que sab√©s del personaje en un solo texto libre ‚Äî la IA genera la ficha completa de una sola vez. El m√°s r√°pido y el que mejores resultados da.</div>
            </button>
            <button class="modo-btn" id="modo-preguntas-btn" onclick="seleccionarModo('preguntas')">
                <div class="modo-btn-icon">‚ùì</div>
                <div class="modo-btn-titulo">Preguntas</div>
                <div class="modo-btn-desc">Formulario con ~20 preguntas organizadas por categor√≠a (apariencia, personalidad, historia, escenario‚Ä¶). Ideal si no sab√©s por d√≥nde empezar o si el personaje es original tuyo.</div>
            </button>
            <button class="modo-btn" id="modo-manual-btn" onclick="seleccionarModo('manual')">
                <div class="modo-btn-icon">‚úé</div>
                <div class="modo-btn-titulo">Paso a paso</div>
                <div class="modo-btn-desc">Complet√°s cada campo uno por uno con ayuda opcional de IA en cada paso. M√°s lento, pero ten√©s control total sobre cada parte de la ficha.</div>
            </button>
        </div>

        <div class="btn-row">
            <button class="btn btn-primary" onclick="avanzarDesdeNombre()">
                <span class="btn-label">Continuar</span>
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PASO EXPRESS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-card" id="step-express">
        <h2 class="step-card-title">Describ√≠ tu personaje</h2>
        <p class="step-card-hint">Escrib√≠ todo lo que sepas: apariencia, personalidad, historia, de qu√© obra es. <strong>Cuanto m√°s detalle, mejor resultado.</strong></p>

        <div class="callout">
            <strong>¬øQu√© incluir?</strong> Apariencia f√≠sica, vestimenta, rasgos de personalidad, c√≥mo habla, trasfondo, de qu√© serie/juego/libro es. Pod√©s mezclar todo sin orden.<br><br>
            <em>Ejemplo: "Es conocido como El Cazador de Piratas. 1,81m, cabello verde puntiagudo, haramaki verde, tres espadas. Cicatriz en ojo izquierdo y cicatriz grande desde hombro hasta cadera. Muy serio y orgulloso, habla poco pero cada palabra pesa. Sue√±a con ser el mejor espadach√≠n del mundo."</em>
        </div>

        <div class="form-group">
            <label>Tu descripci√≥n <span style="color:var(--text-muted);font-size:0.62rem">(m√≠nimo 50 caracteres)</span></label>
            <textarea id="input-idea-base" class="xtall" placeholder="Describ√≠ al personaje con todo lo que sepas..."></textarea>
            <div class="char-count" id="cc-idea">0 / m√≠n. 50</div>
        </div>

        <button class="btn btn-generar" onclick="ejecutarExpress(this)">
            <div class="spinner"></div>
            <span class="btn-label">‚ö° Generar personaje completo</span>
        </button>

        <div class="btn-row" style="margin-top:14px">
            <button class="btn btn-secondary" onclick="volverA0()">Atr√°s</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PASO PREGUNTAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-card" id="step-preguntas">
        <h2 class="step-card-title">Formulario guiado</h2>
        <p class="step-card-hint">Complet√° las preguntas que quieras. <strong>No es obligatorio responder todo</strong> ‚Äî la IA trabaja con lo que le des. M√°s respuestas = mejor resultado.</p>

        <!-- Secci√≥n: Apariencia -->
        <div class="seccion-titulo">üë§ Apariencia f√≠sica y vestimenta</div>
        <div class="preguntas-grid">
            <div class="form-group">
                <label>Altura y complexi√≥n</label>
                <input type="text" id="p-altura" placeholder="Ej: 1,81m, complexi√≥n atl√©tica y musculosa...">
                <div class="ayuda">Qu√© tan alto es y c√≥mo est√° construido f√≠sicamente. Afecta c√≥mo se describe su presencia y movimientos.</div>
            </div>
            <div class="form-group">
                <label>Cabello</label>
                <input type="text" id="p-cabello" placeholder="Ej: verde puntiagudo, con patillas...">
                <div class="ayuda">Color, largo, estilo. Es uno de los rasgos m√°s identificables a primera vista.</div>
            </div>
            <div class="form-group">
                <label>Rasgos faciales</label>
                <input type="text" id="p-rasgos" placeholder="Ej: mirada seria, cicatriz en ojo izquierdo, mand√≠bula firme...">
                <div class="ayuda">Ojos, expresi√≥n habitual, cicatrices, barba, color de piel. Lo que m√°s se nota al mirarlo a la cara.</div>
            </div>
            <div class="form-group">
                <label>Vestimenta habitual</label>
                <input type="text" id="p-vestimenta" placeholder="Ej: camisa blanca, pantalones negros, haramaki verde...">
                <div class="ayuda">Ropa que usa siempre o casi siempre. Dice mucho sobre su personalidad y contexto.</div>
            </div>
            <div class="form-group pregunta-full">
                <label>Detalles f√≠sicos √∫nicos</label>
                <input type="text" id="p-detalles" placeholder="Ej: cicatriz grande desde hombro hasta cadera, tres pendientes dorados en oreja izquierda, vendas en brazos...">
                <div class="ayuda">Accesorios, marcas, tatuajes, h√°bitos f√≠sicos (como cruzar los brazos siempre). Los detalles √∫nicos son lo que hace inconfundible a un personaje.</div>
            </div>
        </div>

        <!-- Secci√≥n: Personalidad -->
        <div class="seccion-titulo">üß† Personalidad y forma de hablar</div>
        <div class="preguntas-grid">
            <div class="form-group">
                <label>¬øC√≥mo habla?</label>
                <input type="text" id="p-habla" placeholder="Ej: directo, pocas palabras, voz ronca y grave...">
                <div class="ayuda">¬øUsa frases cortas o largas? ¬øHabla mucho o poco? ¬øTono formal o informal? Esto define c√≥mo se va a expresar en cada mensaje.</div>
            </div>
            <div class="form-group">
                <label>¬øC√≥mo reacciona al conflicto?</label>
                <input type="text" id="p-reacciones" placeholder="Ej: no se altera, responde con acciones, tensa la mand√≠bula...">
                <div class="ayuda">¬øSe enoja f√°cil? ¬øSe cierra? ¬øAct√∫a en vez de discutir? Define c√≥mo se comporta cuando algo lo molesta o lo presiona.</div>
            </div>
            <div class="form-group">
                <label>Sentido del humor</label>
                <input type="text" id="p-humor" placeholder="Ej: seco y casi inexistente, sarc√°stico ocasional...">
                <div class="ayuda">¬øHace chistes? ¬øIron√≠a? ¬øNo tiene humor en absoluto? Un detalle peque√±o que hace al personaje mucho m√°s real.</div>
            </div>
            <div class="form-group">
                <label>¬øQu√© valora / qu√© lo define?</label>
                <input type="text" id="p-valores" placeholder="Ej: lealtad hasta la muerte, el c√≥digo del guerrero, su sue√±o...">
                <div class="ayuda">Sus principios inamovibles. Lo que nunca har√≠a y por qu√© vive. Es el coraz√≥n de su personalidad.</div>
            </div>
            <div class="form-group pregunta-full">
                <label>¬øQu√© lo hace actuar / cu√°les son sus miedos o deseos ocultos?</label>
                <input type="text" id="p-miedos" placeholder="Ej: le aterra fallarle a alguien importante, desea ser el mejor pero no lo admitir√≠a en voz alta...">
                <div class="ayuda">Lo que no dir√≠a en voz alta pero que gu√≠a sus acciones. Esto hace que el personaje se sienta profundo y real, no solo una lista de rasgos.</div>
            </div>
        </div>

        <!-- Secci√≥n: Historia -->
        <div class="seccion-titulo">üìñ Historia y trasfondo</div>
        <div class="preguntas-grid">
            <div class="form-group">
                <label>Origen o contexto</label>
                <input type="text" id="p-origen" placeholder="Ej: pirata de la tripulaci√≥n Sombrero de Paja, ex cazarrecompensas...">
                <div class="ayuda">De d√≥nde viene, a qu√© grupo pertenece, qu√© hace. Si es un personaje de una obra, pod√©s escribirlo directamente.</div>
            </div>
            <div class="form-group">
                <label>Logros o habilidades destacadas</label>
                <input type="text" id="p-logros" placeholder="Ej: espadach√≠n con tres espadas, sobrevivi√≥ Kizaru, entren√≥ con Mihawk...">
                <div class="ayuda">Sus capacidades m√°s importantes. Ayuda a la IA a entender qu√© tan poderoso, experto o especial es el personaje.</div>
            </div>
            <div class="form-group pregunta-full">
                <label>Historia, traumas o momentos clave</label>
                <textarea id="p-historia" placeholder="Ej: perdi√≥ a su amiga de infancia Kuina y jur√≥ en su nombre convertirse en el mejor. Lleva sus heridas como medallas..."></textarea>
                <div class="ayuda">Experiencias que lo formaron. No necesit√°s escribir toda la historia ‚Äî solo los momentos que m√°s lo definen como persona. Esto da profundidad emocional al personaje.</div>
            </div>
        </div>

        <!-- Secci√≥n: Din√°mica -->
        <div class="seccion-titulo">üí¨ Din√°mica con el usuario</div>
        <div class="preguntas-grid">
            <div class="form-group">
                <label>Tipo de v√≠nculo con el usuario</label>
                <input type="text" id="p-vinculo" placeholder="Ej: compa√±ero de tripulaci√≥n, protector, inter√©s rom√°ntico...">
                <div class="ayuda">¬øQu√© relaci√≥n tienen? ¬øSon amigos, extra√±os, hay tensi√≥n rom√°ntica? Esto define el tono de cada conversaci√≥n.</div>
            </div>
            <div class="form-group">
                <label>¬øC√≥mo trata al usuario?</label>
                <input type="text" id="p-trato" placeholder="Ej: serio pero protector, le baja la guardia lentamente...">
                <div class="ayuda">¬øEs fr√≠o al principio? ¬øC√°lido? ¬øLo toma en serio? ¬øLo protege? Esta pregunta define c√≥mo se va a sentir chatear con √©l.</div>
            </div>
            <div class="form-group pregunta-full">
                <label>¬øC√≥mo evoluciona la relaci√≥n?</label>
                <input type="text" id="p-evolucion" placeholder="Ej: slow burn, al principio distante pero se va abriendo con el tiempo...">
                <div class="ayuda"><strong>Slow burn</strong> = la cercan√≠a crece lento. <strong>Directo</strong> = ya hay confianza desde el principio. <strong>Tenso</strong> = hay fricciones. Esto se traduce en c√≥mo habla el personaje seg√∫n avanza el chat.</div>
            </div>
        </div>

        <!-- Secci√≥n: Escenario -->
        <div class="seccion-titulo">üåç Escenario y ambiente</div>
        <div class="preguntas-grid">
            <div class="form-group">
                <label>Lugar donde suceden las conversaciones</label>
                <input type="text" id="p-lugar" placeholder="Ej: cubierta del Thousand Sunny, barco pirata en el Gran Line...">
                <div class="ayuda">El lugar "default" donde est√° el personaje cuando chateas con √©l. No tiene que ser siempre el mismo, pero tener uno base hace que las respuestas sean m√°s inmersivas.</div>
            </div>
            <div class="form-group">
                <label>Momento del d√≠a / atm√≥sfera</label>
                <input type="text" id="p-atmosfera" placeholder="Ej: atardecer, mar en calma, viento salado, luz dorada...">
                <div class="ayuda">La hora, el clima, el estado del lugar. Detalles sensoriales que hacen que el escenario se sienta real.</div>
            </div>
            <div class="form-group pregunta-full">
                <label>Objetos o detalles del ambiente</label>
                <input type="text" id="p-objetos" placeholder="Ej: botella de sake, espadas colgadas, el crujir de las tablas...">
                <div class="ayuda">Cosas espec√≠ficas del lugar que el personaje puede mencionar, tocar o usar. Los objetos concretos hacen al escenario mucho m√°s v√≠vido que una descripci√≥n gen√©rica.</div>
            </div>
        </div>

        <!-- Secci√≥n NSFW (solo si est√° activado) -->
        <div id="preguntas-nsfw-extra" style="display:none">
            <div class="seccion-titulo" style="color:var(--nsfw);border-bottom-color:rgba(224,90,122,0.3)">üîû Din√°mica √≠ntima</div>
            <div class="preguntas-grid">
                <div class="form-group nsfw-field">
                    <label>C√≥mo es en la intimidad</label>
                    <input type="text" id="p-nsfw-como" placeholder="Ej: intenso y callado, controlado hasta que se suelta...">
                    <div class="ayuda" style="color:rgba(224,90,122,0.6)">C√≥mo cambia su comportamiento en una escena √≠ntima. ¬øSe mantiene serio? ¬øPierde el control? ¬øEs tierno o dominante?</div>
                </div>
                <div class="form-group nsfw-field">
                    <label>Se√±ales de atracci√≥n / tensi√≥n</label>
                    <input type="text" id="p-nsfw-tension" placeholder="Ej: miradas largas, acercamientos sin raz√≥n, protege el espacio del usuario...">
                    <div class="ayuda" style="color:rgba(224,90,122,0.6)">C√≥mo demuestra que le gusta el usuario antes de que pase algo. Gestos sutiles que construyen la tensi√≥n.</div>
                </div>
                <div class="form-group pregunta-full nsfw-field">
                    <label>¬øHay escenas o situaciones √≠ntimas espec√≠ficas que quer√©s?</label>
                    <textarea id="p-nsfw-escenas" placeholder="Ej: momentos despu√©s de una batalla, en el camarote, tensi√≥n antes del combate..."></textarea>
                    <div class="ayuda" style="color:rgba(224,90,122,0.6)">Situaciones o contextos donde quer√©s que se desarrolle la dimensi√≥n √≠ntima del personaje. Cuanto m√°s espec√≠fico, m√°s fiel al resultado.</div>
                </div>
            </div>
        </div>

        <button class="btn btn-generar" onclick="ejecutarPreguntas(this)">
            <div class="spinner"></div>
            <span class="btn-label">‚ú¶ Generar personaje con estas respuestas</span>
        </button>

        <div class="btn-row" style="margin-top:14px">
            <button class="btn btn-secondary" onclick="volverA0()">Atr√°s</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê Progress bar (modo manual) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="progress-wrap" id="progress-manual" style="display:none">
        <div class="progress-steps">
            <div class="step-dot" id="dot-1"><div class="step-dot-circle">1</div><div class="step-dot-label">Descripci√≥n</div></div>
            <div class="step-dot" id="dot-2"><div class="step-dot-circle">2</div><div class="step-dot-label">Personalidad</div></div>
            <div class="step-dot" id="dot-3"><div class="step-dot-circle">3</div><div class="step-dot-label">Escenario</div></div>
            <div class="step-dot" id="dot-4"><div class="step-dot-circle">4</div><div class="step-dot-label">1er Mensaje</div></div>
            <div class="step-dot" id="dot-5"><div class="step-dot-circle">5</div><div class="step-dot-label">Ejemplos</div></div>
            <div class="step-dot" id="dot-6"><div class="step-dot-circle">6</div><div class="step-dot-label">Tags</div></div>
            <div class="step-dot" id="dot-7"><div class="step-dot-circle">7</div><div class="step-dot-label">Revisar</div></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PASO 1: Descripci√≥n ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-card" id="step-1">
        <h2 class="step-card-title">Descripci√≥n f√≠sica</h2>
        <p class="step-card-hint">Apariencia, complexi√≥n, vestimenta y lo que lo hace visualmente reconocible. La IA organiza en prosa fluida <strong>sin inventar nada que no hayas escrito</strong>.</p>
        <div class="callout">
            <strong>¬øPara qu√© sirve este campo?</strong> Es lo que describe al personaje en tercera persona ‚Äî c√≥mo se ve, c√≥mo se mueve, qu√© transmite al entrar a un lugar. El resultado va a tener 3 p√°rrafos: apariencia ‚Üí vestimenta ‚Üí aura.<br><br>
            <strong>Qu√© escribir:</strong> altura, complexi√≥n, color y estilo de cabello, rasgos del rostro, ropa habitual, accesorios, cicatrices o detalles √∫nicos. No hace falta que est√© ordenado.
        </div>
        <div class="form-group">
            <label>Tu descripci√≥n</label>
            <textarea id="input-descripcion" class="tall" placeholder="Ej: Mujer de 30 a√±os, cabello negro corto, ojos grises. Siempre viste de negro. Cicatriz en ceja derecha..."></textarea>
            <div class="ayuda">Escrib√≠ todo lo que se te ocurra sobre c√≥mo se ve. La IA lo va a organizar ‚Äî no hace falta que sea perfecto ni ordenado.</div>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="retroceder(1)">Atr√°s</button>
            <button class="btn btn-ghost" onclick="enriquecerPaso('descripcion', this)"><div class="spinner"></div><span class="btn-label">‚ú¶ Enriquecer con IA</span></button>
            <button class="btn btn-primary" onclick="avanzar(1)"><span class="btn-label">Continuar</span></button>
        </div>
        <div class="ia-result-wrap" id="result-descripcion">
            <div class="ia-result-label">Versi√≥n enriquecida</div>
            <div class="ia-result-box" id="result-descripcion-texto"></div>
            <div class="btn-row" style="margin-top:10px">
                <button class="btn btn-secondary" style="font-size:0.72rem" onclick="usarResultado('descripcion')">‚úì Usar esta versi√≥n</button>
                <button class="btn btn-secondary" style="font-size:0.72rem" onclick="enriquecerPaso('descripcion', this)">Regenerar</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PASO 2: Personalidad ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-card" id="step-2">
        <h2 class="step-card-title">Personalidad</h2>
        <p class="step-card-hint">Escrib√≠ libremente c√≥mo es el personaje. La IA lo convierte en instrucciones <strong>en primera persona</strong> ‚Äî como si el personaje se describiera a s√≠ mismo.</p>
        <div class="callout">
            <strong>¬øPara qu√© sirve?</strong> Es el campo m√°s importante de la ficha. Define c√≥mo habla el personaje en cada mensaje ‚Äî su tono, sus reacciones, qu√© lo hace √∫nico.<br><br>
            <strong>Resultado:</strong> primera persona ‚Äî <code>"Hablo con...", "Cuando me preguntan...", "Mi humor es..."</code><br><br>
            <strong>Qu√© escribir:</strong> c√≥mo habla (formal, directo, po√©tico), c√≥mo reacciona al conflicto, qu√© lo hace re√≠r, qu√© lo enoja, qu√© valora, c√≥mo trata al usuario.
        </div>
        <div class="form-group">
            <label>Rasgos y forma de ser</label>
            <textarea id="input-personalidad" class="tall" placeholder="Ej: Serio pero con sentido del humor seco. Muy orgulloso. No pide ayuda f√°cilmente pero es leal hasta la muerte..."></textarea>
            <div class="ayuda">No hace falta escribirlo en forma de instrucciones ‚Äî escribilo como si describieras a alguien que conoc√©s. La IA lo convierte al formato correcto.</div>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="retroceder(2)">Atr√°s</button>
            <button class="btn btn-ghost" onclick="enriquecerPaso('personalidad', this)"><div class="spinner"></div><span class="btn-label">‚ú¶ Enriquecer con IA</span></button>
            <button class="btn btn-primary" onclick="avanzar(2)"><span class="btn-label">Continuar</span></button>
        </div>
        <div class="ia-result-wrap" id="result-personalidad">
            <div class="ia-result-label">Versi√≥n en primera persona</div>
            <div class="ia-result-box" id="result-personalidad-texto"></div>
            <div class="btn-row" style="margin-top:10px">
                <button class="btn btn-secondary" style="font-size:0.72rem" onclick="usarResultado('personalidad')">‚úì Usar esta versi√≥n</button>
                <button class="btn btn-secondary" style="font-size:0.72rem" onclick="enriquecerPaso('personalidad', this)">Regenerar</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PASO 3: Escenario ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-card" id="step-3">
        <h2 class="step-card-title">Escenario</h2>
        <p class="step-card-hint">¬øD√≥nde suceden las conversaciones? Un lugar espec√≠fico hace que el personaje responda de forma m√°s coherente e inmersiva.</p>
        <div class="callout">
            <strong>¬øPara qu√© sirve?</strong> El escenario aparece al inicio del chat y le da contexto al personaje ‚Äî d√≥nde est√°, qu√© hace cuando lleg√°s. No es obligatorio pero mejora mucho la experiencia.<br><br>
            <strong>Qu√© escribir:</strong> el lugar (oficina, barco, ciudad), el momento del d√≠a, la atm√≥sfera (silencioso, lluvioso, √≠ntimo), objetos o detalles del ambiente.
        </div>
        <div class="form-group">
            <label>Lugar o situaci√≥n</label>
            <textarea id="input-escenario" placeholder="Ej: La cubierta del Thousand Sunny al atardecer, con el mar en calma y olor a sal..."></textarea>
            <div class="ayuda">Pod√©s escribirlo de forma simple ‚Äî la IA agrega los detalles sensoriales. Cuanto m√°s espec√≠fico, mejor.</div>
        </div>
        <div class="color-row">
            <label>üé® Color del fondo:</label>
            <input type="color" id="input-color-escenario" value="#1a1a2e"
                style="width:32px;height:26px;border:1px solid var(--border);background:none;cursor:pointer;border-radius:5px;padding:0"
                oninput="document.getElementById('color-preview').style.background=this.value">
            <div class="color-preview" id="color-preview"><span>vista previa del chat</span></div>
        </div>
        <div class="ayuda" style="margin-top:8px">El color de fondo del chat cuando est√©s hablando con este personaje. Eleg√≠ algo que combine con el ambiente del escenario.</div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="retroceder(3)">Atr√°s</button>
            <button class="btn btn-ghost" onclick="enriquecerPaso('escenario', this)"><div class="spinner"></div><span class="btn-label">‚ú¶ Enriquecer con IA</span></button>
            <button class="btn btn-primary" onclick="avanzar(3)"><span class="btn-label">Continuar</span></button>
        </div>
        <div class="ia-result-wrap" id="result-escenario">
            <div class="ia-result-label">Versi√≥n enriquecida</div>
            <div class="ia-result-box" id="result-escenario-texto"></div>
            <div class="btn-row" style="margin-top:10px">
                <button class="btn btn-secondary" style="font-size:0.72rem" onclick="usarResultado('escenario')">‚úì Usar esta versi√≥n</button>
                <button class="btn btn-secondary" style="font-size:0.72rem" onclick="enriquecerPaso('escenario', this)">Regenerar</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PASO 4: Primer mensaje ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-card" id="step-4">
        <h2 class="step-card-title">Primer mensaje</h2>
        <p class="step-card-hint">Lo primero que ve el usuario. La IA lo escribe en formato roleplay en <strong>primera persona</strong>. Pod√©s dejar el campo vac√≠o y deja que la IA lo cree.</p>
        <div class="callout">
            <strong>¬øPara qu√© sirve?</strong> Es lo que aparece cuando abr√≠s el chat por primera vez ‚Äî el personaje te recibe. Establece el tono de toda la conversaci√≥n.<br><br>
            <strong>Formato que genera la IA:</strong> <code>*acciones entre asteriscos*</code>, di√°logo normal, <code>((pensamientos entre par√©ntesis dobles))</code>.<br><br>
            <strong>Si dej√°s el campo vac√≠o:</strong> la IA crea un inicio natural basado en el escenario y la personalidad. Si escrib√≠s algo, lo usa como punto de partida.
        </div>
        <div class="form-group">
            <label>Situaci√≥n inicial (opcional)</label>
            <textarea id="input-primer_mensaje" placeholder="Ej: Zoro est√° descansando contra el m√°stil cuando el usuario se acerca..."></textarea>
            <div class="ayuda">Describ√≠ la situaci√≥n, no el mensaje en s√≠. La IA escribe el mensaje ‚Äî vos solo dec√≠s qu√© est√° pasando.</div>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="retroceder(4)">Atr√°s</button>
            <button class="btn btn-ghost" onclick="enriquecerPaso('primer_mensaje', this)"><div class="spinner"></div><span class="btn-label">‚ú¶ Generar con IA</span></button>
            <button class="btn btn-primary" onclick="avanzar(4)"><span class="btn-label">Continuar</span></button>
        </div>
        <div class="ia-result-wrap" id="result-primer_mensaje">
            <div class="ia-result-label">Primer mensaje generado</div>
            <div class="ia-result-box" id="result-primer_mensaje-texto" style="font-style:italic"></div>
            <div class="btn-row" style="margin-top:10px">
                <button class="btn btn-secondary" style="font-size:0.72rem" onclick="usarResultado('primer_mensaje')">‚úì Usar este mensaje</button>
                <button class="btn btn-secondary" style="font-size:0.72rem" onclick="enriquecerPaso('primer_mensaje', this)">Regenerar</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PASO 5: Ejemplos ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-card" id="step-5">
        <h2 class="step-card-title">Ejemplos de conversaci√≥n</h2>
        <p class="step-card-hint">Ejemplos que ense√±an al modelo c√≥mo responde el personaje. Pod√©s dejar vac√≠o y la IA elige.</p>
        <div class="callout">
            <strong>¬øPara qu√© sirven?</strong> Son como una "muestra" del personaje en acci√≥n. El modelo los lee para entender su voz, su ritmo y c√≥mo reacciona. Cuanto m√°s representativos, mejor se comporta en el chat.<br><br>
            <strong>Si dej√°s vac√≠o:</strong> la IA elige 2 situaciones representativas seg√∫n la personalidad. Si escrib√≠s, elige situaciones basadas en lo que ped√≠s.
        </div>
        <div class="form-group">
            <label>Situaciones que quer√©s ver (opcional)</label>
            <textarea id="input-ejemplos" placeholder="Ej: Situaci√≥n 1: el usuario est√° asustado antes de un combate. Situaci√≥n 2: el usuario lo desaf√≠a..."></textarea>
            <div class="ayuda">No escribas el di√°logo ‚Äî describ√≠ la situaci√≥n y la IA escribe el intercambio completo. Pod√©s pedir cosas como "cuando el usuario llora", "cuando hay tensi√≥n rom√°ntica", "cuando el usuario lo irrita".</div>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="retroceder(5)">Atr√°s</button>
            <button class="btn btn-ghost" onclick="enriquecerPaso('ejemplos', this)"><div class="spinner"></div><span class="btn-label">‚ú¶ Generar con IA</span></button>
            <button class="btn btn-primary" onclick="avanzar(5)"><span class="btn-label">Continuar</span></button>
        </div>
        <div class="ia-result-wrap" id="result-ejemplos">
            <div class="ia-result-label">Ejemplos generados</div>
            <div class="ia-result-box" id="result-ejemplos-texto" style="font-size:0.9rem"></div>
            <div class="btn-row" style="margin-top:10px">
                <button class="btn btn-secondary" style="font-size:0.72rem" onclick="usarResultado('ejemplos')">‚úì Usar estos ejemplos</button>
                <button class="btn btn-secondary" style="font-size:0.72rem" onclick="enriquecerPaso('ejemplos', this)">Regenerar</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PASO 6: Tags ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-card" id="step-6">
        <h2 class="step-card-title">Tags</h2>
        <p class="step-card-hint">Palabras clave para categorizar el personaje. Pod√©s escribirlos, dejar vac√≠o, o combinar.</p>
        <div class="callout">
            <strong>¬øPara qu√© sirven?</strong> Los tags categorizan al personaje para buscarlo y filtrarlo. No afectan el comportamiento en el chat.<br><br>
            <strong>Qu√© poner:</strong> g√©nero de la historia (romance, acci√≥n, drama), rasgos del personaje (serio, protector, tsundere), tono (slow burn, comedia, dark), y si aplica, contenido (nsfw, explicito).
        </div>
        <div class="form-group">
            <label>Tags (separados por comas, o vac√≠o)</label>
            <input type="text" id="input-tags" placeholder="Ej: pirata, serio, lealtad, slow burn, nsfw...">
            <div class="ayuda">Si dej√°s vac√≠o y us√°s "Sugerir con IA", la IA genera entre 6 y 10 tags basados en todo lo que completaste antes.</div>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="retroceder(6)">Atr√°s</button>
            <button class="btn btn-ghost" onclick="enriquecerPaso('tags', this)"><div class="spinner"></div><span class="btn-label">‚ú¶ Sugerir con IA</span></button>
            <button class="btn btn-primary" onclick="avanzar(6)"><span class="btn-label">Continuar</span></button>
        </div>
        <div class="ia-result-wrap" id="result-tags">
            <div class="ia-result-label">Tags sugeridos ‚Äî click para activar/desactivar</div>
            <div class="tags-preview" id="result-tags-chips"></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PASO 7: Revisar ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="step-card" id="step-7">
        <h2 class="step-card-title">Revisar y guardar</h2>
        <p class="step-card-hint">Revis√° el resumen. Hac√© click en cualquier campo para editarlo.</p>
        <div class="resumen-grid" id="resumen-grid"></div>
        <div class="btn-row" style="margin-top:26px">
            <button class="btn btn-secondary" onclick="retroceder(7)">Atr√°s</button>
            <button class="btn btn-ghost" onclick="descargarJSON()">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                <span class="btn-label">Descargar JSON</span>
            </button>
            <button class="btn btn-primary" id="btn-guardar" onclick="guardarPersonaje()">
                <div class="spinner"></div>
                <span class="btn-label">‚ú¶ Crear personaje</span>
            </button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê √âxito ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="success-screen" id="success-screen">
        <div class="success-icon">‚ú¶</div>
        <h2 class="success-title" id="success-nombre">Personaje creado</h2>
        <p class="success-subtitle">Est√° listo para chatear.</p>
        <div class="success-actions">
            <a href="/" class="btn btn-primary">Ir al chat</a>
            <button class="btn btn-secondary" onclick="reiniciar()">Crear otro</button>
        </div>
    </div>

</div>

<div class="notif" id="notif"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTADO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let modoActual    = 'express';
let nsfwActivo    = false;
let modoMemoria   = 'roleplay';   // 'roleplay' | 'compa√±ero'
let modoManualStep = 1;

const campos = {
    nombre: '', descripcion: '', personalidad: '',
    escenario: '', primer_mensaje: '', ejemplos: '',
    tags: [], color_escenario: '#1a1a2e',
};

const pasoACampo = { 1:'descripcion', 2:'personalidad', 3:'escenario', 4:'primer_mensaje', 5:'ejemplos', 6:'tags' };
let tagsSeleccionados = [];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NSFW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function toggleNSFW() {
    nsfwActivo = !nsfwActivo;
    const wrap  = document.getElementById('nsfw-toggle');
    const panel = document.getElementById('nsfw-panel');
    const extra = document.getElementById('preguntas-nsfw-extra');

    wrap.classList.toggle('activo', nsfwActivo);
    panel.classList.toggle('visible', nsfwActivo);
    if (extra) extra.style.display = nsfwActivo ? 'block' : 'none';
}

function toggleModoMemoria() {
    modoMemoria = modoMemoria === 'roleplay' ? 'compa√±ero' : 'roleplay';
    const wrap  = document.getElementById('modo-toggle');
    const label = document.getElementById('modo-toggle-label');
    const desc  = document.getElementById('modo-toggle-desc');
    const esCompanero = modoMemoria === 'compa√±ero';

    wrap.classList.toggle('companion', esCompanero);
    label.textContent = esCompanero ? 'üíú Modo: Compa√±ero' : 'üé≠ Modo: Roleplay';
    desc.textContent  = esCompanero
        ? 'La IA recuerda datos del usuario Y momentos especiales de la relaci√≥n'
        : 'La IA solo recuerda datos reales del usuario, no acciones de ficci√≥n';
}

function getDatosNSFW() {
    if (!nsfwActivo) return {};
    return {
        dinamica_intima : document.getElementById('nsfw-dinamica')?.value.trim() || '',
        rol_dominante   : document.getElementById('nsfw-rol')?.value.trim() || '',
        preferencias    : document.getElementById('nsfw-preferencias')?.value.trim() || '',
        tono_nsfw       : document.getElementById('nsfw-tono')?.value.trim() || '',
        limites         : document.getElementById('nsfw-limites')?.value.trim() || '',
        escena_tipica   : document.getElementById('nsfw-escena')?.value.trim() || '',
        // campos del formulario de preguntas
        como_intimo     : document.getElementById('p-nsfw-como')?.value.trim() || '',
        tension         : document.getElementById('p-nsfw-tension')?.value.trim() || '',
        escenas_esp     : document.getElementById('p-nsfw-escenas')?.value.trim() || '',
    };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function seleccionarModo(modo) {
    modoActual = modo;
    ['express', 'preguntas', 'manual'].forEach(m => {
        document.getElementById(`modo-${m}-btn`).classList.toggle('selected', m === modo);
    });
}

function avanzarDesdeNombre() {
    const nombre = document.getElementById('input-nombre').value.trim();
    if (!nombre) { notif('Escrib√≠ un nombre para continuar', 'error'); return; }
    campos.nombre = nombre;

    document.getElementById('progress-manual').style.display = 'none';

    if (modoActual === 'express') {
        mostrarStep('step-express');
    } else if (modoActual === 'preguntas') {
        mostrarStep('step-preguntas');
    } else {
        mostrarStep('step-1');
        document.getElementById('progress-manual').style.display = 'block';
        modoManualStep = 1;
        actualizarDots(1);
    }
}

function volverA0() {
    document.getElementById('progress-manual').style.display = 'none';
    mostrarStep('step-0');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODO EXPRESS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function ejecutarExpress(btn) {
    const idea = document.getElementById('input-idea-base').value.trim();
    if (idea.length < 20) { notif('Escrib√≠ al menos 20 caracteres', 'error'); return; }

    const datos_nsfw = getDatosNSFW();
    await ejecutarGeneracion(btn, '/api/crear/express', {
        nombre: campos.nombre, idea_base: idea, nsfw: nsfwActivo, datos_nsfw
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODO PREGUNTAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function ejecutarPreguntas(btn) {
    const respuestas = {
        // Apariencia
        altura_complexion : document.getElementById('p-altura')?.value.trim() || '',
        cabello           : document.getElementById('p-cabello')?.value.trim() || '',
        rasgos_faciales   : document.getElementById('p-rasgos')?.value.trim() || '',
        vestimenta        : document.getElementById('p-vestimenta')?.value.trim() || '',
        detalles_fisicos  : document.getElementById('p-detalles')?.value.trim() || '',
        // Personalidad
        forma_de_hablar   : document.getElementById('p-habla')?.value.trim() || '',
        reacciones        : document.getElementById('p-reacciones')?.value.trim() || '',
        humor             : document.getElementById('p-humor')?.value.trim() || '',
        valores           : document.getElementById('p-valores')?.value.trim() || '',
        miedos_deseos     : document.getElementById('p-miedos')?.value.trim() || '',
        // Historia
        origen            : document.getElementById('p-origen')?.value.trim() || '',
        logros            : document.getElementById('p-logros')?.value.trim() || '',
        historia          : document.getElementById('p-historia')?.value.trim() || '',
        // Din√°mica
        relacion_usuario  : document.getElementById('p-vinculo')?.value.trim() || '',
        como_trata        : document.getElementById('p-trato')?.value.trim() || '',
        evolucion         : document.getElementById('p-evolucion')?.value.trim() || '',
        // Escenario
        lugar             : document.getElementById('p-lugar')?.value.trim() || '',
        atmosfera         : document.getElementById('p-atmosfera')?.value.trim() || '',
        objetos           : document.getElementById('p-objetos')?.value.trim() || '',
    };

    // Verificar que al menos un campo tenga valor
    const tieneAlgo = Object.values(respuestas).some(v => v.length > 0);
    if (!tieneAlgo) { notif('Complet√° al menos una pregunta', 'error'); return; }

    const datos_nsfw = getDatosNSFW();
    await ejecutarGeneracion(btn, '/api/crear/preguntas', {
        nombre: campos.nombre, respuestas, nsfw: nsfwActivo, datos_nsfw
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FUNCI√ìN COM√öN DE GENERACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function ejecutarGeneracion(btn, endpoint, body) {
    btn.classList.add('loading');
    btn.disabled = true;

    const overlay = document.getElementById('overlay-carga');
    const msg     = document.getElementById('overlay-msg');
    overlay.classList.add('show');

    const mensajes = [
        'Analizando el personaje...', 'Generando descripci√≥n...',
        'Escribiendo personalidad en primera persona...',
        'Construyendo el escenario...', 'Redactando el primer mensaje...',
        'Creando ejemplos de conversaci√≥n...', 'Finalizando la ficha...',
    ];
    let mi = 0;
    msg.textContent = mensajes[0];
    const interval = setInterval(() => { mi = (mi + 1) % mensajes.length; msg.textContent = mensajes[mi]; }, 1800);

    try {
        const resp = await fetch(endpoint, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (data.error) { notif(`Error: ${data.error}`, 'error'); return; }

        const c = data.campos;

        // Forzar string en todos los campos de texto (Mistral a veces devuelve arrays u objetos)
        const toStr = v => {
            if (!v) return '';
            if (typeof v === 'string') return v;
            if (Array.isArray(v)) return v.map(i => typeof i === 'object' ? JSON.stringify(i, null, 2) : String(i)).join('\n\n');
            if (typeof v === 'object') return JSON.stringify(v, null, 2);
            return String(v);
        };

        campos.descripcion    = toStr(c.descripcion);
        campos.personalidad   = toStr(c.personalidad);
        campos.escenario      = toStr(c.escenario);
        campos.primer_mensaje = toStr(c.primer_mensaje);
        campos.ejemplos       = toStr(c.ejemplos);
        campos.tags           = Array.isArray(c.tags) ? c.tags.map(String) : [];
        tagsSeleccionados     = [...campos.tags];

        setVal('input-descripcion',    campos.descripcion);
        setVal('input-personalidad',   campos.personalidad);
        setVal('input-escenario',      campos.escenario);
        setVal('input-primer_mensaje', campos.primer_mensaje);
        setVal('input-ejemplos',       campos.ejemplos);
        setVal('input-tags',           campos.tags.join(', '));

        document.getElementById('progress-manual').style.display = 'none';
        mostrarStep('step-7');
        renderResumen();
        notif('‚ú¶ Personaje generado', 'success');

    } catch (err) {
        notif('Error de conexi√≥n', 'error');
        console.error(err);
    } finally {
        clearInterval(interval);
        overlay.classList.remove('show');
        btn.classList.remove('loading');
        btn.disabled = false;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVEGACI√ìN MANUAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function avanzar(desde) {
    guardarCampoActual(desde);
    if (desde === 1 && !campos.descripcion.trim()) { notif('Complet√° la descripci√≥n para continuar', 'error'); return; }
    const siguiente = desde + 1;
    if (siguiente > 7) return;
    modoManualStep = siguiente;
    mostrarStep(`step-${siguiente}`);
    actualizarDots(siguiente);
    if (siguiente === 7) renderResumen();
}

function retroceder(desde) {
    if (desde <= 1) { volverA0(); return; }
    guardarCampoActual(desde);
    modoManualStep = desde - 1;
    mostrarStep(`step-${desde - 1}`);
    actualizarDots(desde - 1);
}

function irAPaso(paso) {
    document.getElementById('progress-manual').style.display = 'block';
    modoManualStep = paso;
    mostrarStep(`step-${paso}`);
    actualizarDots(paso);
    const campo = pasoACampo[paso];
    if (campo && campo !== 'tags') {
        const el = document.getElementById(`input-${campo}`);
        if (el && campos[campo]) el.value = campos[campo];
    }
}

function mostrarStep(id) {
    document.querySelectorAll('.step-card').forEach(c => c.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function actualizarDots(activo) {
    for (let i = 1; i <= 7; i++) {
        const dot = document.getElementById(`dot-${i}`);
        if (!dot) continue;
        dot.classList.remove('active', 'done');
        if (i < activo) dot.classList.add('done');
        if (i === activo) dot.classList.add('active');
    }
}

function guardarCampoActual(paso) {
    const campo = pasoACampo[paso];
    if (!campo) return;
    if (campo === 'tags') {
        campos.tags = tagsSeleccionados.length
            ? [...tagsSeleccionados]
            : document.getElementById('input-tags').value.split(',').map(t => t.trim()).filter(Boolean);
        return;
    }
    const el = document.getElementById(`input-${campo}`);
    if (el) campos[campo] = el.value.trim();
    if (paso === 3) campos.color_escenario = document.getElementById('input-color-escenario')?.value || '#1a1a2e';
}

function setVal(id, val) { const el = document.getElementById(id); if (el) el.value = val; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENRIQUECIMIENTO INDIVIDUAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function enriquecerPaso(paso, btn) {
    guardarCampoActual(modoManualStep);
    const inputEl = document.getElementById(`input-${paso}`);
    const valor   = inputEl ? inputEl.value.trim() : campos[paso] || '';
    const opcionales = ['primer_mensaje', 'ejemplos', 'tags'];
    if (!valor && !opcionales.includes(paso)) { notif('Escrib√≠ algo primero', 'error'); return; }

    btn.classList.add('loading');
    btn.disabled = true;

    try {
        const resp = await fetch('/api/crear/paso', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                paso, nombre: campos.nombre,
                valor: valor || `Generar para ${campos.nombre}`,
                contexto: {
                    descripcion: campos.descripcion, personalidad: campos.personalidad,
                    escenario: campos.escenario, primer_mensaje: campos.primer_mensaje,
                },
                nsfw: nsfwActivo,
                datos_nsfw: getDatosNSFW(),
            })
        });
        const data = await resp.json();
        if (data.error) { notif(`Error: ${data.error}`, 'error'); return; }
        mostrarResultado(paso, data.resultado);
    } catch (err) {
        notif('Error de conexi√≥n', 'error');
    } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
    }
}

function mostrarResultado(paso, resultado) {
    const wrap = document.getElementById(`result-${paso}`);
    wrap.classList.add('visible');
    if (paso === 'tags') {
        const tags = Array.isArray(resultado) ? resultado : [];
        tagsSeleccionados = [...tags];
        renderTagChips(tags);
        return;
    }
    document.getElementById(`result-${paso}-texto`).textContent = resultado;
}

function renderTagChips(tags) {
    document.getElementById('result-tags-chips').innerHTML = tags.map(t =>
        `<span class="tag-chip" onclick="toggleTag('${t.replace(/'/g,"\\'")}', this)">${t}</span>`
    ).join('');
}

function toggleTag(tag, el) {
    const idx = tagsSeleccionados.indexOf(tag);
    if (idx >= 0) { tagsSeleccionados.splice(idx, 1); el.classList.add('desactivado'); }
    else { tagsSeleccionados.push(tag); el.classList.remove('desactivado'); }
}

function usarResultado(paso) {
    const textoEl = document.getElementById(`result-${paso}-texto`);
    if (!textoEl) return;
    const inputEl = document.getElementById(`input-${paso}`);
    if (inputEl) inputEl.value = textoEl.textContent;
    campos[paso] = textoEl.textContent;
    notif('‚ú¶ Versi√≥n de IA aplicada', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESUMEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderResumen() {
    guardarCampoActual(modoManualStep);
    const items = [
        { titulo: 'Nombre',         valor: campos.nombre,         paso: 0 },
        { titulo: 'Descripci√≥n',    valor: campos.descripcion,    paso: 1 },
        { titulo: 'Personalidad',   valor: campos.personalidad,   paso: 2 },
        { titulo: 'Escenario',      valor: campos.escenario,      paso: 3 },
        { titulo: 'Primer mensaje', valor: campos.primer_mensaje, paso: 4 },
        { titulo: 'Ejemplos',       valor: campos.ejemplos,       paso: 5 },
        { titulo: 'Tags',           valor: (campos.tags || []).join(', '), paso: 6 },
    ];
    document.getElementById('resumen-grid').innerHTML = items.map(item => {
        const valorStr = (item.valor != null && typeof item.valor !== 'string') ? String(item.valor) : (item.valor || '');
        const ok = valorStr.trim().length > 0;
        const preview = valorStr.length > 250 ? valorStr.slice(0,250)+'...' : valorStr;
        return `<div class="resumen-item ${ok ? 'resumen-ok' : 'resumen-vacio'}" ${item.paso > 0 ? `onclick="irAPaso(${item.paso})"` : ''}>
            <div class="resumen-item-titulo">${item.titulo}</div>
            <div class="resumen-item-texto">${ok ? preview : '<em style="color:var(--text-muted)">Sin completar</em>'}</div>
        </div>`;
    }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GUARDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function guardarPersonaje() {
    if (!campos.nombre || !campos.descripcion) { notif('Nombre y descripci√≥n son obligatorios', 'error'); return; }
    const btn = document.getElementById('btn-guardar');
    btn.classList.add('loading'); btn.disabled = true;
    try {
        const resp = await fetch('/api/crear/finalizar', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                nombre: campos.nombre, descripcion: campos.descripcion,
                personalidad: campos.personalidad, escenario: campos.escenario,
                primer_mensaje: campos.primer_mensaje, ejemplos: campos.ejemplos,
                tags: campos.tags, notas: 'Creado con el asistente de personajes.',
                color_escenario: campos.color_escenario,
                modo_memoria: modoMemoria,
            })
        });
        const data = await resp.json();
        if (data.success) { window._lastCard = data.card; mostrarExito(campos.nombre); }
        else notif(`Error: ${data.error}`, 'error');
    } catch (err) {
        notif('Error de conexi√≥n', 'error');
    } finally {
        btn.classList.remove('loading'); btn.disabled = false;
    }
}

function mostrarExito(nombre) {
    document.querySelectorAll('.step-card').forEach(c => c.style.display = 'none');
    const pw = document.querySelector('.progress-wrap');
    if (pw) pw.style.display = 'none';
    document.getElementById('success-nombre').textContent = `"${nombre}" est√° listo`;
    document.getElementById('success-screen').classList.add('show');
}

function reiniciar() { window.location.reload(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DESCARGAR JSON
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function descargarJSON() {
    guardarCampoActual(modoManualStep);
    const card = {
        spec: "chara_card_v2", spec_version: "2.0",
        data: { name: campos.nombre, description: campos.descripcion, personality: campos.personalidad,
                scenario: campos.escenario, first_mes: campos.primer_mensaje, mes_example: campos.ejemplos,
                creator_notes: "Creado con el asistente de personajes.", tags: campos.tags,
                character_version: "1.0", modo_memoria: modoMemoria }
    };
    const blob = new Blob([JSON.stringify(card, null, 2)], { type: 'application/json' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = `${campos.nombre || 'personaje'}.json`; a.click();
    URL.revokeObjectURL(url);
    notif('JSON descargado', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let notifTimer = null;
function notif(msg, tipo = 'info') {
    const el = document.getElementById('notif');
    el.textContent = msg; el.className = `notif ${tipo} show`;
    if (notifTimer) clearTimeout(notifTimer);
    notifTimer = setTimeout(() => el.classList.remove('show'), 3500);
}

document.getElementById('input-idea-base').addEventListener('input', function() {
    const n = this.value.length;
    const el = document.getElementById('cc-idea');
    el.textContent = `${n} / m√≠n. 50`;
    el.style.color = n >= 50 ? 'var(--success)' : 'var(--text-muted)';
});

document.getElementById('input-nombre').addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); avanzarDesdeNombre(); }
});
</script>
</body>
</html>
